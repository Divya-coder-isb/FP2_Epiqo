# -*- coding: utf-8 -*-
"""Untitled52.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OiRZzlqYbTpY2cSUa4NGriWN_N-bfaJp
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import xgboost as xgb
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.sequence import pad_sequences
from datetime import datetime, timedelta
from sklearn.preprocessing import MinMaxScaler
from PIL import Image
import requests
import os

# Helper function to download files from GitHub
def download_file(url, filename):
    response = requests.get(url)
    with open(filename, 'wb') as f:
        f.write(response.content)

# Download models from GitHub if they don't exist
if not os.path.exists("xgboost_full_model.json"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/xgboost_full_model.json", "xgboost_full_model.json")
if not os.path.exists("lstm_full_model.h5"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/lstm_full_model.h5", "lstm_full_model.h5")
if not os.path.exists("svm_full_model.pkl"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/svm_full_model.pkl", "svm_full_model.pkl")

# Load models
xgb_model = xgb.Booster()
xgb_model.load_model("xgboost_full_model.json")
lstm_model = load_model("lstm_full_model.h5")
svm_model = joblib.load("svm_full_model.pkl")

# Download images from GitHub if they don't exist
if not os.path.exists("banner_image.png"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/Screenshot%202024-07-03%20135327.png", "banner_image.png")
if not os.path.exists("bearish.png"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/Bearish.png", "bearish.png")
if not os.path.exists("bullish.png"):
    download_file("https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/Bullish.png", "bullish.png")

# Load images
banner_image = Image.open("banner_image.png")
bearish_image = Image.open("bearish.png")
bullish_image = Image.open("bullish.png")

# Helper functions
def create_lagged_features(data, num_lags=10):
    for i in range(1, num_lags + 1):
        data[f'lag_{i}'] = data['Close'].shift(i)
    data.dropna(inplace=True)
    return data

def create_sequences(data, n_steps):
    X = []
    for i in range(n_steps, len(data)):
        X.append(data[i-n_steps:i])
    return np.array(X)

def prepare_data_for_prediction(date, num_lags=10):
    # Load data
    url = "https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/tatamotors_historical_data.csv"
    data = pd.read_csv(url)
    data['Date'] = pd.to_datetime(data['Date'])
    data.set_index('Date', inplace=True)

    # Create lagged features
    data = create_lagged_features(data, num_lags)

    # Ensure the feature set matches the training data exactly
    feature_cols = ['Open', 'High', 'Low', 'Volume', 'Dividends', 'Stock Splits'] + [f'lag_{i}' for i in range(1, num_lags + 1)]
    features = data[feature_cols].iloc[-1].values.reshape(1, -1)

    return features, data

def prepare_lstm_data(date, n_steps=60):
    # Load data
    url = "https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/tatamotors_historical_data.csv"
    data = pd.read_csv(url)
    data['Date'] = pd.to_datetime(data['Date'])
    data.set_index('Date', inplace=True)

    # Normalize the entire dataset
    scaler = MinMaxScaler(feature_range=(0, 1))
    scaled_data = scaler.fit_transform(data[['Close']])

    # Create sequences
    X_full = create_sequences(scaled_data, n_steps)

    return X_full, scaler

# Define functions to predict using the XGBoost and LSTM models
def predict_xgb(selected_date):
    features, _ = prepare_data_for_prediction(selected_date)
    dmatrix = xgb.DMatrix(features, feature_names=[
        'Open', 'High', 'Low', 'Volume', 'Dividends', 'Stock Splits',
        'lag_1', 'lag_2', 'lag_3', 'lag_4', 'lag_5', 'lag_6',
        'lag_7', 'lag_8', 'lag_9', 'lag_10'
    ])

    # Predict using the XGBoost model
    pred = xgb_model.predict(dmatrix)
    return pred[0]

def predict_lstm(selected_date):
    X_full, scaler = prepare_lstm_data(selected_date)

    # Predict using the LSTM model
    pred_scaled = lstm_model.predict(X_full[-1].reshape(1, 60, 1))
    pred = scaler.inverse_transform(pred_scaled)
    return pred[0][0]

def calculate_rsi(series, period=14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0))
    loss = (-delta.where(delta < 0, 0))

    avg_gain = gain.rolling(window=period, min_periods=1).mean()
    avg_loss = loss.rolling(window=period, min_periods=1).mean()

    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

def prepare_svm_data(data):
    # Create lagged features for SVM model
    num_lags = 10
    for i in range(1, num_lags + 1):
        data[f'lag_{i}'] = data['Close'].shift(i)
    data.dropna(inplace=True)

    return data

def predict_trend_with_rsi(forecasted_price):
    # Load data
    url = "https://github.com/Divya-coder-isb/FP2_Epiqo/raw/main/tatamotors_historical_data.csv"
    data = pd.read_csv(url)
    data['Date'] = pd.to_datetime(data['Date'])
    data.set_index('Date', inplace=True)

    # Append the forecasted price to the dataset
    latest_date = data.index[-1] + timedelta(days=1)
    data = data.append(pd.DataFrame({'Close': [forecasted_price]}, index=[latest_date]))

    # Calculate RSI
    rsi = calculate_rsi(data['Close'])
    latest_rsi = rsi.iloc[-1]

    # Prepare data for SVM
    data = prepare_svm_data(data)
    scaler_X = MinMaxScaler(feature_range=(0, 1))
    X_scaled = scaler_X.fit_transform(data[[f'lag_{i}' for i in range(1, 11)]])
    trend_pred = svm_model.predict(X_scaled[-1].reshape(1, -1))[0]

    return classify_trend(latest_rsi), trend_pred

def classify_trend(rsi):
    if rsi > 70:
        return 'Bullish', bullish_image
    elif rsi < 30:
        return 'Bearish', bearish_image
    else:
        return 'Neutral', None

def validate_date(selected_date):
    if selected_date.weekday() >= 5:
        st.error("Select the trading days only")
        return False
    return True

# Streamlit UI
st.image(banner_image, use_column_width=True)
st.write("## Tata Motors Limited (TATAMOTORS.NS)")
st.write("It offers its products to fleet owners, transporters, government agencies, defense, public transport utilities, small and medium enterprises (SMEs), agriculture and rural segment, mining and construction industry, etc. The company was incorporated in 1945 and is headquartered in Mumbai, India.")

min_date = datetime.today() + timedelta(days=1)
max_date = min_date + timedelta(days=3650)  # 10 years from today

selected_date = st.date_input("Select a date", min_value=min_date, max_value=max_date, value=min_date)
forecast_type = st.radio("Forecast Type", ('Short term', 'Long term'))

if st.button("Apply"):
    if validate_date(selected_date):
        if forecast_type == 'Short term':
            price = predict_xgb(selected_date)
            st.write(f"Short term Adj closing price: {price} INR")
        else:
            price = predict_lstm(selected_date)
            st.write(f"Long term Adj closing price: {price} INR")

        trend, trend_image = predict_trend_with_rsi(price)
        st.write(f"Market Trend: {trend}")
        if trend_image:
            st.image(trend_image, width=100)

# Display date in the box
st.write(f"Selected Date: {selected_date}")

